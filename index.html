<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ワイヤーフレーム3Dドラゴンバトル 完全版</title>
<style>
body{margin:0;overflow:hidden;background:#000;font-family:'Courier New',monospace;color:#0F0;}
canvas{display:block;margin:0 auto;border:2px solid #0F0;}
#game-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:flex;flex-direction:column;justify-content:space-between;padding:10px;box-sizing:border-box;}
#top-left-info,#bottom-left-info,#bottom-right-info{background:rgba(0,0,0,0.5);border:1px solid #0F0;padding:5px;}
#bottom-right-info{align-self:flex-end;}
#start-screen,#config-screen,#key-binding-screen{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);border:1px solid #0F0;padding:20px;display:none;flex-direction:column;align-items:center;z-index:100;}
button{background:#0F0;color:#000;border:none;padding:8px 16px;margin:4px;cursor:pointer;}
button:hover{background:#050;color:#FFF;}
#config-tabs{display:flex;flex-wrap:wrap;}
.tab-button{border:1px solid #0F0;background:rgba(0,0,0,0.5);color:#0F0;padding:6px 12px;cursor:pointer;margin-right:4px;}
.tab-button.active{background:#0F0;color:#000;}
.tab-content{display:none;margin-top:10px;}
.tab-content.active{display:block;}
.key-input-box{border:1px solid #0F0;padding:4px;min-width:40px;text-align:center;cursor:pointer;}
.key-input-box.listening{background:#050;}
.message{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px;background:rgba(0,0,0,0.8);color:#F00;border:2px solid #F00;display:none;z-index:200;}
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<div id="game-overlay">
  <div id="top-left-info">
    <div id="player-hp-box">HP: <span id="playerHP">100</span></div>
    <div id="dragon-hp-box">Dragon HP: <span id="dragonHP">100</span></div>
  </div>
  <div id="bottom-left-info">
    <div id="altitude-box">Altitude: <span id="altitude">0</span></div>
    <div id="score-box">Score: <span id="score">0</span></div>
  </div>
  <div id="bottom-right-info"></div>
</div>

<div id="start-screen" style="display:flex;flex-direction:column;align-items:center;">
  <h2>ワイヤーフレーム3Dドラゴンバトル</h2>
  <p>WASD: 上下左右, Q/E: 前後, Space: 攻撃<br>C: コンフィグ, R: リセット</p>
  <button id="startBtn">ゲームスタート</button>
  <button id="startConfigBtn">コンフィグ</button>
</div>

<div id="config-screen">
  <h2>設定</h2>
  <div id="config-tabs">
    <button class="tab-button active" data-tab="controls">操作設定</button>
    <button class="tab-button" data-tab="game">ゲーム設定</button>
    <button class="tab-button" data-tab="display">表示設定</button>
    <button class="tab-button" data-tab="audio">音響設定</button>
  </div>
  <div id="controls-tab" class="tab-content active">
    <button id="keybindButton">キーバインド設定</button>
    <div>
      <label for="control-preset">プリセット:</label>
      <select id="control-preset">
        <option value="default">デフォルト</option>
        <option value="old">旧設定</option>
      </select>
    </div>
  </div>
  <div id="game-tab" class="tab-content">
    <label>難易度:
      <select id="difficulty">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
      </select>
    </label>
    <div>
      <label>速度:
        <input type="range" id="player-speed" min="0.5" max="2.0" step="0.1" value="1">
        <span id="player-speed-value">1.0x</span>
      </label>
    </div>
  </div>
  <div id="display-tab" class="tab-content">
    <label>背景色<input type="color" id="background-color" value="#000000"></label>
    <label><input type="checkbox" id="show-hp" checked>HP</label>
    <label><input type="checkbox" id="show-altitude" checked>高度</label>
    <label><input type="checkbox" id="show-score" checked>スコア</label>
    <label><input type="checkbox" id="show-controls" checked>操作ガイド</label>
  </div>
  <div id="audio-tab" class="tab-content">
    <label>効果音:<input type="checkbox" id="sfx-toggle" checked></label>
    <label>音量:
      <input type="range" id="sfx-volume" min="0" max="1" step="0.1" value="0.5">
      <span id="sfx-volume-value">0.5</span>
    </label>
  </div>
  <div>
    <button id="saveConfig">保存して閉じる</button>
    <button id="resetConfig">デフォルトに戻す</button>
  </div>
</div>

<div id="key-binding-screen">
  <h2>キーバインド設定</h2>
  <ul>
    <li>前進:<div class="key-input-box" data-action="moveForward">Q</div></li>
    <li>後退:<div class="key-input-box" data-action="moveBackward">E</div></li>
    <li>上昇:<div class="key-input-box" data-action="moveUp">W</div></li>
    <li>下降:<div class="key-input-box" data-action="moveDown">S</div></li>
    <li>左移動:<div class="key-input-box" data-action="moveLeft">A</div></li>
    <li>右移動:<div class="key-input-box" data-action="moveRight">D</div></li>
    <li>攻撃:<div class="key-input-box" data-action="attack">SPACE</div></li>
    <li>コンフィグ:<div class="key-input-box" data-action="config">C</div></li>
    <li>リセット:<div class="key-input-box" data-action="reset">R</div></li>
  </ul>
  <button id="saveKeybindings">保存</button>
  <button id="resetKeybindings">デフォルト</button>
</div>

<div id="message" class="message"></div>

<script>
/* ===== JavaScript 全機能実装 ===== */

/*** === 基本変数とデフォルト設定 === ***/
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");
let gameRunning=false,lastTime=0,score=0;
let player,dragon,bullets=[],dragonBullets=[];
const camera={x:0,y:0,z:-100,distance:500};
let backgroundColor="#000000";
let playerColor="#00FF00", dragonColor="#FF0000";
let sfxEnabled=true, sfxVolume=0.5;
let showHP=true, showAltitude=true, showScore=true, showControls=true;
let playerMoveSpeed=1.0;
let gameDifficulty="normal";
let keyPressed={};
const defaultKeybindings={
  moveForward:"Q",moveBackward:"E",moveUp:"W",moveDown:"S",moveLeft:"A",moveRight:"D",
  attack:"SPACE",config:"C",reset:"R"
};
let keybindings={...defaultKeybindings};

/*** === ユーティリティ === ***/
class Vector3{
  constructor(x=0,y=0,z=0){this.x=x;this.y=y;this.z=z;}
  add(v){return new Vector3(this.x+v.x,this.y+v.y,this.z+v.z);}
  sub(v){return new Vector3(this.x-v.x,this.y-v.y,this.z-v.z);}
  mul(s){return new Vector3(this.x*s,this.y*s,this.z*s);}
  magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);}
  normalize(){let m=this.magnitude();return m?this.mul(1/m):new Vector3();}
  distanceTo(v){return this.sub(v).magnitude();}
}
function project(p,cameraPos,distance){
  let rx=p.x-cameraPos.x, ry=p.y-cameraPos.y, rz=p.z-cameraPos.z;
  if(rz>=distance) return null;
  let s=distance/(distance-rz);
  return {x:rx*s+canvas.width/2, y:-ry*s+canvas.height/2};
}
function playSound(v,freq,dur){
  if(!sfxEnabled)return;
  const ac=new(AudioContext||webkitAudioContext)();
  const osc=ac.createOscillator();
  const gain=ac.createGain();
  osc.type="square";osc.frequency.setValueAtTime(freq,ac.currentTime);
  gain.gain.setValueAtTime(v*sfxVolume,ac.currentTime);
  osc.connect(gain);gain.connect(ac.destination);
  osc.start();osc.stop(ac.currentTime+dur);
}

/*** === オブジェクトクラス === ***/
class GameObject{
  constructor(x,y,z,color,hp=0){
    this.position=new Vector3(x,y,z);
    this.vertices=[];this.edges=[];
    this.color=color;this.hp=hp;this.maxHp=hp;this.isActive=true;
  }
  draw(cam){
    ctx.strokeStyle=this.color;
    let verts=this.vertices.map(v=>project(this.position.add(v),cam,camera.distance));
    for(let e of this.edges){
      let v1=verts[e[0]],v2=verts[e[1]];
      if(v1&&v2){ctx.beginPath();ctx.moveTo(v1.x,v1.y);ctx.lineTo(v2.x,v2.y);ctx.stroke();}
    }
  }
  takeDamage(d){
    this.hp-=d; if(this.hp<=0){this.hp=0;this.isActive=false;return true;} return false;
  }
}

class Player extends GameObject{
  constructor(x,y,z){
    super(x,y,z,playerColor,100);
    this.vertices=[new Vector3(0,5,0),new Vector3(-5,-5,5),new Vector3(5,-5,5),new Vector3(0,-5,-5)];
    this.edges=[[0,1],[0,2],[0,3],[1,2],[2,3],[3,1]];
    this.speed=50*playerMoveSpeed;this.cooldown=0;
    this.altitudeLimit=150;this.boundary=200;
  }
  update(dt){
    let v=new Vector3();
    if(keyPressed[keybindings.moveForward]) v.z+=1;
    if(keyPressed[keybindings.moveBackward]) v.z-=1;
    if(keyPressed[keybindings.moveUp]) v.y+=1;
    if(keyPressed[keybindings.moveDown]) v.y-=1;
    if(keyPressed[keybindings.moveLeft]) v.x-=1;
    if(keyPressed[keybindings.moveRight]) v.x+=1;
    if(v.magnitude()>0)v=v.normalize().mul(this.speed*dt);
    this.position=this.position.add(v);
    //境界制限
    this.position.x=Math.max(-this.boundary,Math.min(this.boundary,this.position.x));
    this.position.y=Math.max(-this.altitudeLimit,Math.min(this.altitudeLimit,this.position.y));
    this.position.z=Math.max(-this.boundary,Math.min(this.boundary,this.position.z));
    if(keyPressed[keybindings.attack]) this.shoot();
    if(this.cooldown>0)this.cooldown-=dt;
  }
  shoot(){
    if(this.cooldown<=0){
      bullets.push(new Bullet(this.position.x,this.position.y,this.position.z,120,new Vector3(0,0,1),playerColor,10));
      this.cooldown=0.2; playSound(0.05,440,0.05);
    }
  }
}

class Dragon extends GameObject{
  constructor(x,y,z){
    super(x,y,z,dragonColor,200);
    this.vertices=[new Vector3(0,0,10),new Vector3(0,5,5),new Vector3(0,-5,5),
        new Vector3(0,0,-10),new Vector3(-10,0,0),new Vector3(10,0,0)];
    this.edges=[[0,1],[0,2],[1,2],[1,4],[2,4],[1,5],[2,5],[3,4],[3,5]];
    this.speed=20;this.cooldown=0;this.timer=0;
  }
  update(dt){
    this.timer+=dt;
    this.position.y=50+Math.sin(this.timer)*30;
    if(this.cooldown>0)this.cooldown-=dt;
    //難易度による設定
    if(gameDifficulty=="easy"){this.speed=15;}
    else if(gameDifficulty=="hard"){this.speed=25;}
    //攻撃
    if(Math.random()<0.02 && this.cooldown<=0){
      let dir=player.position.sub(this.position).normalize();
      dragonBullets.push(new Bullet(this.position.x,this.position.y,this.position.z,100,dir,dragonColor,5));
      this.cooldown=3; playSound(0.08,100,0.08);
    }
    //移動追跡
    let dir=player.position.sub(this.position).normalize();
    this.position=this.position.add(dir.mul(this.speed*dt));
  }
}

class Bullet extends GameObject{
  constructor(x,y,z,speed,dir,color,damage){
    super(x,y,z,color,1);
    this.vertices=[new Vector3(0,0,0),new Vector3(0,0,3)]; this.edges=[[0,1]];
    this.vel=dir.normalize().mul(speed); this.damage=damage; this.life=2;
  }
  update(dt){
    this.position=this.position.add(this.vel.mul(dt));
    this.life-=dt; if(this.life<=0)this.isActive=false;
  }
}

/*** === ゲーム制御 === ***/
function initGame(){
  player=new Player(0,0,0);
  dragon=new Dragon(0,50,200);
  bullets=[];dragonBullets=[]; score=0;
  lastTime=performance.now();
}
function checkCollision(a,b){return a.isActive&&b.isActive&&a.position.distanceTo(b.position)<15;}
function update(dt){
  player.update(dt); dragon.update(dt);
  bullets.forEach(b=>{
    b.update(dt);
    if(checkCollision(b,dragon)){
      dragon.takeDamage(b.damage); b.isActive=false; score+=10;
      playSound(0.05,600,0.05);
    }
  });
  bullets=bullets.filter(b=>b.isActive);
  dragonBullets.forEach(b=>{
    b.update(dt);
    if(checkCollision(b,player)){
      player.takeDamage(b.damage); b.isActive=false;
      playSound(0.05,150,0.05);
    }
  });
  dragonBullets=dragonBullets.filter(b=>b.isActive);
  if(!dragon.isActive){showMessage("ドラゴン撃破！","#0F0");gameRunning=false;}
  if(!player.isActive){showMessage("ゲームオーバー","#F00");gameRunning=false;}
}
function draw(){
  ctx.fillStyle=backgroundColor; ctx.fillRect(0,0,canvas.width,canvas.height);
  let cam={x:player.position.x+camera.x,y:player.position.y+camera.y,z:player.position.z+camera.z};
  player.draw(cam); dragon.draw(cam);
  bullets.forEach(b=>b.draw(cam));
  dragonBullets.forEach(b=>b.draw(cam));
}

/*** === UIとループ === ***/
function updateUI(){
  document.getElementById("playerHP").textContent=player.hp;
  document.getElementById("dragonHP").textContent=dragon.hp;
  document.getElementById("altitude").textContent=player.position.y.toFixed(0);
  document.getElementById("score").textContent=score;
  document.getElementById("player-hp-box").style.display=showHP?"block":"none";
  document.getElementById("dragon-hp-box").style.display=showHP?"block":"none";
  document.getElementById("altitude-box").style.display=showAltitude?"block":"none";
  document.getElementById("score-box").style.display=showScore?"block":"none";
}
function showMessage(msg,color){
  const m=document.getElementById("message");
  m.textContent=msg; m.style.color=color; m.style.borderColor=color; m.style.display="block";
  setTimeout(()=>{m.style.display="none";},2000);
}
function gameLoop(t){
  let dt=(t-lastTime)/1000; lastTime=t;
  if(gameRunning)update(dt);
  draw(); updateUI();
  requestAnimationFrame(gameLoop);
}

/*** === 入力 === ***/
document.addEventListener("keydown",e=>{
  let key=(e.key===" ")?"SPACE":e.key.toUpperCase();
  keyPressed[key]=true;
  if(key===keybindings.config) toggleConfigScreen();
  if(key===keybindings.reset){initGame();gameRunning=true;}
});
document.addEventListener("keyup",e=>{
  let key=(e.key===" ")?"SPACE":e.key.toUpperCase();
  keyPressed[key]=false;
});

/*** === コンフィグと保存 === ***/
function toggleConfigScreen(){
  const cs=document.getElementById("config-screen");
  if(cs.style.display==="flex"){ cs.style.display="none"; gameRunning=true; }
  else { cs.style.display="flex"; gameRunning=false; loadConfig(); }
}
function saveConfig(){
  const s={
    keybindings, playerMoveSpeed, gameDifficulty,
    playerColor,dragonColor,backgroundColor,
    showHP,showAltitude,showScore,showControls,
    sfxEnabled,sfxVolume
  };
  localStorage.setItem("wf3d_settings",JSON.stringify(s));
}
function loadConfig(){
  const data=localStorage.getItem("wf3d_settings"); if(!data)return;
  const s=JSON.parse(data); Object.assign(window,s);
}

/*** === イベント === ***/
document.getElementById("startBtn").addEventListener("click",()=>{
  document.getElementById("start-screen").style.display="none";
  initGame(); gameRunning=true;
});
document.getElementById("startConfigBtn").addEventListener("click",()=>{
  document.getElementById("start-screen").style.display="none";
  toggleConfigScreen();
});
document.getElementById("saveConfig").addEventListener("click",()=>{
  saveConfig(); toggleConfigScreen();
});
document.getElementById("resetConfig").addEventListener("click",()=>{
  localStorage.removeItem("wf3d_settings"); location.reload();
});

/*** === 実行開始 === ***/
initGame();
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
